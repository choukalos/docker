define(['jquery','underscore','mage/template','priceUtils','priceBox','jquery/ui','jquery/jquery.parsequery'],function($,_,mageTemplate){'use strict';$.widget('mage.configurable',{options:{superSelector:'.super-attribute-select',selectSimpleProduct:'[name="selected_configurable_option"]',priceHolderSelector:'.price-box',spConfig:{},state:{},priceFormat:{},optionTemplate:'<%- data.label %>'+"<% if (typeof data.finalPrice.value !== 'undefined') { %>"+' <%- data.finalPrice.formatted %>'+'<% } %>',mediaGallerySelector:'[data-gallery-role=gallery-placeholder]',mediaGalleryInitial:null,slyOldPriceSelector:'.sly-old-price',onlyMainImg:false},_create:function(){this._initializeOptions();this._overrideDefaults();this._setupChangeEvents();this._fillState();this._setChildSettings();this._configureForValues();},_initializeOptions:function(){var options=this.options,gallery=$(options.mediaGallerySelector),priceBoxOptions=$(this.options.priceHolderSelector).priceBox('option').priceConfig||null;if(priceBoxOptions&&priceBoxOptions.optionTemplate){options.optionTemplate=priceBoxOptions.optionTemplate;}
if(priceBoxOptions&&priceBoxOptions.priceFormat){options.priceFormat=priceBoxOptions.priceFormat;}
options.optionTemplate=mageTemplate(options.optionTemplate);options.settings=options.spConfig.containerId?$(options.spConfig.containerId).find(options.superSelector):$(options.superSelector);options.values=options.spConfig.defaultValues||{};options.parentImage=$('[data-role=base-image-container] img').attr('src');this.inputSimpleProduct=this.element.find(options.selectSimpleProduct);gallery.on('gallery:loaded',function(){var galleryObject=gallery.data('gallery');options.mediaGalleryInitial=galleryObject.returnCurrentImages();});},_overrideDefaults:function(){var hashIndex=window.location.href.indexOf('#');if(hashIndex!==-1){this._parseQueryParams(window.location.href.substr(hashIndex+1));}
if(this.options.spConfig.inputsInitialized){this._setValuesByAttribute();}},_parseQueryParams:function(queryString){var queryParams=$.parseQuery({query:queryString});$.each(queryParams,$.proxy(function(key,value){this.options.values[key]=value;},this));},_setValuesByAttribute:function(){this.options.values={};$.each(this.options.settings,$.proxy(function(index,element){var attributeId;if(element.value){attributeId=element.id.replace(/[a-z]*/,'');this.options.values[attributeId]=element.value;}},this));},_setupChangeEvents:function(){$.each(this.options.settings,$.proxy(function(index,element){$(element).on('change',this,this._configure);},this));},_fillState:function(){$.each(this.options.settings,$.proxy(function(index,element){var attributeId=element.id.replace(/[a-z]*/,'');if(attributeId&&this.options.spConfig.attributes[attributeId]){element.config=this.options.spConfig.attributes[attributeId];element.attributeId=attributeId;this.options.state[attributeId]=false;}},this));},_setChildSettings:function(){var childSettings=[],settings=this.options.settings,index=settings.length,option;while(index--){option=settings[index];if(index){option.disabled=true;}else{this._fillSelect(option);}
_.extend(option,{childSettings:childSettings.slice(),prevSetting:settings[index-1],nextSetting:settings[index+1]});childSettings.push(option);}},_configureForValues:function(){if(this.options.values){this.options.settings.each($.proxy(function(index,element){var attributeId=element.attributeId;element.value=this.options.values[attributeId]||'';this._configureElement(element);},this));}},_configure:function(event){event.data._configureElement(this);},_configureElement:function(element){this.simpleProduct=this._getSimpleProductId(element);if(element.value){this.options.state[element.config.id]=element.value;if(element.nextSetting){element.nextSetting.disabled=false;this._fillSelect(element.nextSetting);this._resetChildren(element.nextSetting);}else{if(!!document.documentMode){this.inputSimpleProduct.val(element.options[element.selectedIndex].config.allowedProducts[0]);}else{this.inputSimpleProduct.val(element.selectedOptions[0].config.allowedProducts[0]);}}}else{this._resetChildren(element);}
this._reloadPrice();this._displayRegularPriceBlock(this.simpleProduct);this._changeProductImage();},_changeProductImage:function(){var images,initialImages=$.extend(true,[],this.options.mediaGalleryInitial),galleryObject=$(this.options.mediaGallerySelector).data('gallery');if(this.options.spConfig.images[this.simpleProduct]){images=$.extend(true,[],this.options.spConfig.images[this.simpleProduct]);}
function updateGallery(imagesArr){var imgToUpdate,mainImg;mainImg=imagesArr.filter(function(img){return img.isMain;});imgToUpdate=mainImg.length?mainImg[0]:imagesArr[0];galleryObject.updateDataByIndex(0,imgToUpdate);galleryObject.seek(1);}
if(galleryObject){if(images){images.map(function(img){img.type='image';});if(this.options.onlyMainImg){updateGallery(images);}else{galleryObject.updateData(images)}}else{if(this.options.onlyMainImg){updateGallery(initialImages);}else{galleryObject.updateData(this.options.mediaGalleryInitial);$(this.options.mediaGallerySelector).AddFotoramaVideoEvents();}}}},_resetChildren:function(element){if(element.childSettings){_.each(element.childSettings,function(set){set.selectedIndex=0;set.disabled=true;});if(element.config){this.options.state[element.config.id]=false;}}},_fillSelect:function(element){var attributeId=element.id.replace(/[a-z]*/,''),options=this._getAttributeOptions(attributeId),prevConfig,index=1,allowedProducts,i,j;this._clearSelect(element);element.options[0]=new Option('','');element.options[0].innerHTML=this.options.spConfig.chooseText;prevConfig=false;if(element.prevSetting){prevConfig=element.prevSetting.options[element.prevSetting.selectedIndex];}
if(options){for(i=0;i<options.length;i++){allowedProducts=[];if(prevConfig){for(j=0;j<options[i].products.length;j++){if(prevConfig.config&&prevConfig.config.allowedProducts&&prevConfig.config.allowedProducts.indexOf(options[i].products[j])>-1){allowedProducts.push(options[i].products[j]);}}}else{allowedProducts=options[i].products.slice(0);}
if(allowedProducts.length>0){options[i].allowedProducts=allowedProducts;element.options[index]=new Option(this._getOptionLabel(options[i]),options[i].id);if(typeof options[i].price!=='undefined'){element.options[index].setAttribute('price',options[i].prices);}
element.options[index].config=options[i];index++;}}}},_getOptionLabel:function(option){return option.label;},_clearSelect:function(element){var i;for(i=element.options.length-1;i>=0;i--){element.remove(i);}},_getAttributeOptions:function(attributeId){if(this.options.spConfig.attributes[attributeId]){return this.options.spConfig.attributes[attributeId].options;}},_reloadPrice:function(){$(this.options.priceHolderSelector).trigger('updatePrice',this._getPrices());},_getPrices:function(){var prices={},elements=_.toArray(this.options.settings),hasProductPrice=false;_.each(elements,function(element){var selected=element.options[element.selectedIndex],config=selected&&selected.config,priceValue={};if(config&&config.allowedProducts.length===1&&!hasProductPrice){priceValue=this._calculatePrice(config);hasProductPrice=true;}
prices[element.attributeId]=priceValue;},this);return prices;},_calculatePrice:function(config){var displayPrices=$(this.options.priceHolderSelector).priceBox('option').prices,newPrices=this.options.spConfig.optionPrices[_.first(config.allowedProducts)];_.each(displayPrices,function(price,code){if(newPrices[code]){displayPrices[code].amount=newPrices[code].amount-displayPrices[code].amount;}});return displayPrices;},_getSimpleProductId:function(element){var allOptions=element.config.options,value=element.value,config;config=_.filter(allOptions,function(option){return option.id===value;});config=_.first(config);return _.isEmpty(config)?undefined:_.first(config.allowedProducts);},_displayRegularPriceBlock:function(optionId){if(typeof optionId!='undefined'&&this.options.spConfig.optionPrices[optionId].oldPrice.amount!=this.options.spConfig.optionPrices[optionId].finalPrice.amount){$(this.options.slyOldPriceSelector).show();}else{$(this.options.slyOldPriceSelector).hide();}}});return $.mage.configurable;});