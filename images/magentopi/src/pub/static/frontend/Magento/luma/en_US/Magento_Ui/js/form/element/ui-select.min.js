define(['underscore','./abstract','Magento_Ui/js/lib/key-codes','mage/translate','ko','jquery','Magento_Ui/js/lib/view/utils/async'],function(_,Abstract,keyCodes,$t,ko,$){'use strict';var isTouchDevice=typeof document.ontouchstart!=='undefined';function flattenCollection(array,separator,created){var i=0,length,childCollection;array=_.compact(array);length=array.length;created=created||[];for(i;i<length;i++){created.push(array[i]);if(array[i].hasOwnProperty(separator)){childCollection=array[i][separator];delete array[i][separator];flattenCollection.call(this,childCollection,separator,created);}}
return created;}
function setProperty(array,separator,level,path){var i=0,length,nextLevel,nextPath;array=_.compact(array);length=array.length;level=level||0;path=path||'';for(i;i<length;i++){if(array[i]){_.extend(array[i],{level:level,path:path});}
if(array[i].hasOwnProperty(separator)){nextLevel=level+1;nextPath=path?path+'.'+array[i].label:array[i].label;setProperty.call(this,array[i][separator],separator,nextLevel,nextPath);}}
return array;}
function parseOptions(nodes){var caption,value,cacheNodes,copyNodes;nodes=setProperty(nodes,'optgroup');copyNodes=JSON.parse(JSON.stringify(nodes));cacheNodes=flattenCollection(copyNodes,'optgroup');nodes=_.map(nodes,function(node){value=node.value;if(value==null||value===''){if(_.isUndefined(caption)){caption=node.label;}}else{return node;}});return{options:_.compact(nodes),cacheOptions:{plain:_.compact(cacheNodes),tree:_.compact(nodes)}};}
return Abstract.extend({defaults:{options:[],listVisible:false,value:[],filterOptions:false,chipsEnabled:true,itemsQuantity:'',filterInputValue:'',filterOptionsFocus:false,multiselectFocus:false,multiple:true,selectType:'tree',lastSelectable:false,showFilteredQuantity:true,showCheckbox:true,levelsVisibility:true,openLevelsAction:true,showOpenLevelsActionIcon:true,optgroupLabels:false,closeBtn:true,showPath:true,labelsDecoration:false,disableLabel:false,filterRateLimit:500,closeBtnLabel:$t('Done'),optgroupTmpl:'ui/grid/filters/elements/ui-select-optgroup',quantityPlaceholder:$t('options'),hoverClass:'_hover',rootListSelector:'ul.admin__action-multiselect-menu-inner._root',visibleOptionSelector:'li.admin__action-multiselect-menu-inner-item:visible',actionTargetSelector:'.action-menu-item',selectedPlaceholders:{defaultPlaceholder:$t('Select...'),lotPlaceholders:$t('Selected')},hoverElIndex:null,separator:'optgroup',listens:{listVisible:'cleanHoveredElement',filterInputValue:'filterOptionsList',options:'checkOptionsList'},presets:{single:{showCheckbox:false,chipsEnabled:false,closeBtn:false},optgroup:{showCheckbox:false,lastSelectable:true,optgroupLabels:true,openLevelsAction:false,labelsDecoration:true,showOpenLevelsActionIcon:false}}},initialize:function(){this._super();$.async(this.rootListSelector,this,this.onRootListRender.bind(this));return this;},initConfig:function(config){var result=parseOptions(config.options),defaults=this.constructor.defaults,multiple=_.isBoolean(config.multiple)?config.multiple:defaults.multiple,type=config.selectType||defaults.selectType,showOpenLevelsActionIcon=_.isBoolean(config.showOpenLevelsActionIcon)?config.showOpenLevelsActionIcon:defaults.showOpenLevelsActionIcon,openLevelsAction=_.isBoolean(config.openLevelsAction)?config.openLevelsAction:defaults.openLevelsAction;multiple=!multiple?'single':false;config.showOpenLevelsActionIcon=showOpenLevelsActionIcon&&openLevelsAction;_.extend(config,result,defaults.presets[multiple],defaults.presets[type]);this._super();return this;},hasChildList:function(){return _.find(this.options(),function(option){return!!option[this.separator];},this);},isTree:function(){return this.hasChildList()&&this.selectType!=='optgroup';},addLastElement:function(data){if(!data.hasOwnProperty(this.separator)){!this.cacheOptions.lastOptions?this.cacheOptions.lastOptions=[]:false;if(!_.findWhere(this.cacheOptions.lastOptions,{value:data.value})){this.cacheOptions.lastOptions.push(data);}
return true;}
return false;},checkOptionsList:function(options){if(options.length>this.cacheOptions.plain.length){this.cacheOptions.plain=options;this.setCaption();}},isLabelDecoration:function(data){return data.hasOwnProperty(this.separator)&&this.labelsDecoration;},initObservable:function(){this._super();this.observe(['listVisible','hoverElIndex','placeholder','multiselectFocus','options','itemsQuantity','filterInputValue','filterOptionsFocus']);this.filterInputValue.extend({rateLimit:this.filterRateLimit});return this;},keyDownHandlers:function(){return{enterKey:this.enterKeyHandler,escapeKey:this.escapeKeyHandler,spaceKey:this.enterKeyHandler,pageUpKey:this.pageUpKeyHandler,pageDownKey:this.pageDownKeyHandler};},showLevels:function(data){var curLevel=++data.level,isVisible;if(data.visible){isVisible=data.visible();}else{isVisible=!!data.hasOwnProperty(this.separator)&&_.isBoolean(this.levelsVisibility)&&this.levelsVisibility||data.hasOwnProperty(this.separator)&&parseInt(this.levelsVisibility,10)>=curLevel;data.visible=ko.observable(isVisible);data.isVisited=isVisible;}
return isVisible;},getLevelVisibility:function(data){if(data.visible){return data.visible();}
return this.showLevels(data);},setOption:function(option,options){var copyOptionsTree;options=options||this.cacheOptions.tree;_.each(options,function(opt){if(opt.value==option.parent){delete option.parent;opt[this.separator]?opt[this.separator].push(option):opt[this.separator]=[option];copyOptionsTree=JSON.parse(JSON.stringify(this.cacheOptions.tree));this.cacheOptions.plain=flattenCollection(copyOptionsTree,this.separator);this.options(this.cacheOptions.tree);}else if(opt[this.separator]){this.setOption(option,opt[this.separator]);}},this);},outerClick:function(){this.listVisible()?this.listVisible(false):false;if(isTouchDevice){this.multiselectFocus(false);}},filterOptionsKeydown:function(data,event){var key=keyCodes[event.keyCode];!this.isTabKey(event)?event.stopPropagation():false;if(key==='pageDownKey'||key==='pageUpKey'){event.preventDefault();this.filterOptionsFocus(false);this.cacheUiSelect.focus();}
this.keydownSwitcher(data,event);return true;},filterOptionsList:function(){var value=this.filterInputValue().trim().toLowerCase(),array=[];if(value&&value.length<2){return false;}
this.cleanHoveredElement();if(!value){this.renderPath=false;this.options(this.cacheOptions.tree);this._setItemsQuantity(false);return false;}
this.showPath?this.renderPath=true:false;if(this.filterInputValue()){array=this.selectType==='optgroup'?this._getFilteredArray(this.cacheOptions.lastOptions,value):this._getFilteredArray(this.cacheOptions.plain,value);if(!value.length){this.options(this.cacheOptions.plain);this._setItemsQuantity(this.cacheOptions.plain.length);}else{this.options(array);this._setItemsQuantity(array.length);}
return false;}
this.options(this.cacheOptions.plain);},_getFilteredArray:function(list,value){var i=0,array=[],curOption;for(i;i<list.length;i++){curOption=list[i].label.toLowerCase();if(curOption.indexOf(value)>-1){array.push(list[i]);}}
return array;},getPath:function(data){var pathParts,createdPath='';if(this.renderPath){pathParts=data.path.split('.');_.each(pathParts,function(curData){createdPath=createdPath?createdPath+' / '+curData:curData;});return createdPath;}},_setItemsQuantity:function(data){if(this.showFilteredQuantity){data||parseInt(data,10)===0?this.itemsQuantity(data+' '+this.quantityPlaceholder):this.itemsQuantity('');}},removeSelected:function(value,data,event){event?event.stopPropagation():false;this.value.remove(value);},isTabKey:function(event){return keyCodes[event.keyCode]==='tabKey';},cleanHoveredElement:function(){if(this.hoveredElement){$(this.hoveredElement).children(this.actionTargetSelector).removeClass(this.hoverClass);this.hoveredElement=null;}
return this;},isSelected:function(value){return this.multiple?_.contains(this.value(),value):this.value()===value;},isOptgroupLabels:function(data){return data.hasOwnProperty(this.separator)&&this.optgroupLabels;},isHovered:function(data){var element=this.hoveredElement,elementData;if(!element){return false;}
elementData=ko.dataFor(this.hoveredElement);return data.value===elementData.value;},toggleListVisible:function(){this.listVisible(!this.listVisible());return this;},getSelected:function(){var selected=this.value();return this.cacheOptions.plain.filter(function(opt){return _.isArray(selected)?_.contains(selected,opt.value):selected==opt.value;});},toggleOptionSelected:function(data){var isSelected=this.isSelected(data.value);if(this.lastSelectable&&data.hasOwnProperty(this.separator)){return this;}
if(!this.multiple){if(!isSelected){this.value(data.value);}
this.listVisible(false);}else{if(!isSelected){this.value.push(data.value);}else{this.value(_.without(this.value(),data.value));}}
return this;},openChildLevel:function(data){var contextElement=data,isVisible;if(this.openLevelsAction&&data.hasOwnProperty(this.separator)&&_.isBoolean(this.levelsVisibility)||this.openLevelsAction&&data.hasOwnProperty(this.separator)&&parseInt(this.levelsVisibility,10)<=data.level){isVisible=!contextElement.visible();if(isVisible&&!contextElement.isVisited){contextElement.isVisited=true;}
contextElement.visible(isVisible);}},hasData:function(){if(!this.value()){this.value([]);}
return this.value()?!!this.value().length:false;},onMousemove:function(){},onDelegatedMouseMouve:function(event){var target=$(event.currentTarget).closest(this.visibleOptionSelector)[0];if(this.isCursorPositionChange(event)||this.hoveredElement===target){return;}
this._hoverTo(target);this.setCursorPosition(event);},getOptionIndex:function(data){var index;_.each(this.cacheOptions.plain,function(opt,id){if(data.value===opt.value){index=id;}});return index;},setCursorPosition:function(event){this.cursorPosition={x:event.pageX,y:event.pageY};},isCursorPositionChange:function(event){return this.cursorPosition&&this.cursorPosition.x===event.pageX&&this.cursorPosition.y===event.pageY;},onFocusIn:function(ctx,event){!this.cacheUiSelect?this.cacheUiSelect=event.target:false;this.multiselectFocus(true);},onFocusOut:function(){this.multiselectFocus(false);},enterKeyHandler:function(){if(this.filterOptionsFocus()){return false;}
if(this.listVisible()){if(this.hoveredElement){this.toggleOptionSelected(ko.dataFor(this.hoveredElement));}}else{this.setListVisible(true);}},escapeKeyHandler:function(){this.listVisible()?this.setListVisible(false):false;},pageDownKeyHandler:function(){this._setHoverToElement(1);},_getElemByData:function(data){var i=0,list=$(this.cacheUiSelect).find('li'),length=this.options().length,result;for(i;i<length;i++){if(this.options()[i].value===data.value){result=$(list[i]);}}
return result;},_setHoverToElement:function(direction){var element;if(direction===1){element=this._getNextElement();}else if(direction===-1){element=this._getPreviousElement();}
if(element){this._hoverTo(element);this._scrollTo(element);}},_scrollTo:function(element){var curEl=$(element).children(this.actionTargetSelector),wrapper=$(this.rootList),curElPos={},wrapperPos={};curElPos.start=curEl.offset().top;curElPos.end=curElPos.start+curEl.outerHeight();wrapperPos.start=wrapper.offset().top;wrapperPos.end=wrapperPos.start+wrapper.height();if(curElPos.start<wrapperPos.start){wrapper.scrollTop(wrapper.scrollTop()-(wrapperPos.start-curElPos.start));}else if(curElPos.end>wrapperPos.end){wrapper.scrollTop(wrapper.scrollTop()+curElPos.end-wrapperPos.end);}},pageUpKeyHandler:function(){this._setHoverToElement(-1);},keydownSwitcher:function(data,event){var keyName=keyCodes[event.keyCode];if(this.isTabKey(event)){if(!this.filterOptionsFocus()&&this.listVisible()&&this.filterOptions){this.cacheUiSelect.blur();this.filterOptionsFocus(true);this.cleanHoveredElement();return false;}
this.listVisible(false);return true;}
if(this.keyDownHandlers().hasOwnProperty(keyName)){this.keyDownHandlers()[keyName].apply(this,arguments);}else{return true;}},setCaption:function(){var length;if(!_.isArray(this.value())&&this.value()){length=1;}else if(this.value()){length=this.value().length;}else{this.value([]);length=0;}
if(length>1){this.placeholder(length+' '+this.selectedPlaceholders.lotPlaceholders);}else if(length&&this.getSelected().length){this.placeholder(this.getSelected()[0].label);}else{this.placeholder(this.selectedPlaceholders.defaultPlaceholder);}
return this.placeholder();},setListVisible:function(value){this.listVisible(value);},getPreview:function(){var selected=this.getSelected();return selected.map(function(option){return option.label;}).join(', ');},_getPreviousElement:function(){var currentElement=this.hoveredElement,lastElement=this._getLastIn(this.rootList),previousElement;if(!currentElement){return lastElement;}
previousElement=$(currentElement).prev()[0];return(this._getLastIn(previousElement)||previousElement||this._getFirstParentOf(currentElement)||lastElement);},_getNextElement:function(){var currentElement=this.hoveredElement,firstElement=this._getFirstIn(this.rootList);if(!currentElement){return firstElement;}
return(this._getFirstIn(currentElement)||$(currentElement).next()[0]||this._getParentsOf(currentElement).next()[0]||firstElement);},_getFirstIn:function(scope){return $(scope).find(this.visibleOptionSelector)[0];},_getLastIn:function(scope){return $(scope).find(this.visibleOptionSelector).last()[0];},_getParentsOf:function(scope){return $(scope).parents(this.visibleOptionSelector);},_getFirstParentOf:function(scope){return this._getParentsOf(scope)[0];},_hoverTo:function(element){if(this.hoveredElement){$(this.hoveredElement).children(this.actionTargetSelector).removeClass(this.hoverClass);}
$(element).children(this.actionTargetSelector).addClass(this.hoverClass);this.hoveredElement=element;},onRootListRender:function(element){var targetSelector='li > '+this.actionTargetSelector;this.rootList=element;$(this.rootList).on('mousemove',targetSelector,this.onDelegatedMouseMouve.bind(this));}});});