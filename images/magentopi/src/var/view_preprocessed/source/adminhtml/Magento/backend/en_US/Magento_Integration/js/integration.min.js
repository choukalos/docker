define(["jquery","Magento_Ui/js/modal/alert","jquery/ui","mage/translate","Magento_Ui/js/modal/modal"],function($,alert){"use strict";$.widget('mage.integration',{options:{gridUrl:''},_create:function(){if($('#save-split-button-activate').length){this._form=$('#edit_form');this._form.on('saveAndActivate',$.proxy(this._saveAndActivate,this));}},_saveAndActivate:function(){if(this._form.validation&&!this._form.validation('isValid')){return false;}
$.ajax({url:this._form.prop('action'),type:'post',data:this._form.serialize(),dataType:'json',context:this,beforeSend:function(){$('body').trigger('processStart');},success:function(data){if(data['_redirect']){window.location.href=data['_redirect'];}else if(data['integrationId']){var integrationName=$('#integration_properties_name').val();window.integration.popup.show($('<span>').attr({'data-row-dialog':'permissions','data-row-id':data['integrationId'],'data-row-name':$('<div>').text(integrationName).html(),'data-row-is-reauthorize':'0','data-row-is-token-exchange':data['isTokenExchange']}));var that=this;$('#integration-popup-container').on('dialogclose',function(){$('body').trigger('processStart');window.location.href=that.options.gridUrl;return false;});}},error:function(jqXHR,status,error){alert({content:$.mage.__('Sorry, something went wrong. Please try again later.')});window.console&&console.log(status+': '+error+"\nResponse text:\n"+jqXHR.responseText);},complete:function(){$('body').trigger('processStop');}});return true;}});window.Integration=function(permissionsDialogUrl,tokensDialogUrl,tokensExchangeUrl,gridUrl,successCallbackUrl){var url={permissions:permissionsDialogUrl,tokens:tokensDialogUrl,tokensExchange:tokensExchangeUrl,grid:gridUrl};var IdentityLogin={win:null,strLocation:null,checker:null,isCalledBack:false,jqInfoDialog:$('#integration-popup-container'),successCallbackUrl:successCallbackUrl,Constants:{CHECKER_INTERVAL:500,WIDTH:680,HEIGHT:510,LEFT:screen.width-680-30,TOP:screen.height-510-300},invokePopup:function(identityCallbackUrl,consumerKey,jqInfoDialog){IdentityLogin.isCalledBack=false;IdentityLogin.jqInfoDialog=jqInfoDialog;var param=$.param({"oauth_consumer_key":consumerKey,"success_call_back":IdentityLogin.successCallbackUrl});IdentityLogin.win=window.open(identityCallbackUrl+'?'+param,'','top='+IdentityLogin.Constants.TOP+', left='+IdentityLogin.Constants.LEFT+', width='+IdentityLogin.Constants.WIDTH+', height='+IdentityLogin.Constants.HEIGHT+',scrollbars=no');if(IdentityLogin.checker!=null){clearInterval(IdentityLogin.checker);}
IdentityLogin.checker=setInterval(IdentityLogin.fnCheckLocation,IdentityLogin.Constants.CHECKER_INTERVAL);},fnCheckLocation:function(){if(IdentityLogin.win==null){return;}
try{if(IdentityLogin.win.closed||(IdentityLogin.win.location.href==IdentityLogin.successCallbackUrl)){clearInterval(IdentityLogin.checker);$('body').trigger('processStart');window.location.reload();IdentityLogin.jqInfoDialog.modal('closeModal');}}catch(e){if(IdentityLogin.win.closed){IdentityLogin.jqInfoDialog.modal('closeModal');clearInterval(IdentityLogin.checker);}
return;}}};var isPopupBlocked=function(popupWindow){try{popupWindow.focus();}catch(e){alert({content:$.mage.__("Popup Blocker is enabled! Please add this site to your exception list.")});return true;}
return false;};var _showPopup=function(dialog,title,okButton,url){$.ajax({url:url,cache:false,data:{form_key:window.FORM_KEY},method:'GET',beforeSend:function(){$('body').trigger('processStart');},success:function(result){var redirect=result._redirect;if(redirect){window.location.href=redirect;return;}
var identityLinkUrl=null,consumerKey=null,popupHtml=null,popup=$('#integration-popup-container');try{var resultObj=typeof result==='string'?JSON.parse(result):result;identityLinkUrl=resultObj['identity_link_url'];consumerKey=resultObj['oauth_consumer_key'];popupHtml=resultObj['popup_content'];}catch(e){}
if(identityLinkUrl&&consumerKey&&popupHtml){IdentityLogin.invokePopup(identityLinkUrl,consumerKey,popup);if(isPopupBlocked(IdentityLogin.win)){return;}}else{popupHtml=result;}
if(popup.length===0){popup=$('<div/>');}
popup.html(popupHtml);var buttons=[],dialogProperties={title:title,type:'slide',dialogClass:dialog=='permissions'?'integration-dialog':'integration-dialog no-close',};if(okButton){buttons.push(okButton);}
if(buttons.length>0){dialogProperties['buttons']=buttons}
popup.modal(dialogProperties);popup.modal('openModal');},error:function(jqXHR,status,error){alert({content:$.mage.__('Sorry, something went wrong. Please try again later.')});window.console&&console.log(status+': '+error+"\nResponse text:\n"+jqXHR.responseText);},complete:function(){$('body').trigger('processStop');}})};return{popup:{show:function(ctx){var dialog=$(ctx).attr('data-row-dialog');var isReauthorize=$(ctx).attr('data-row-is-reauthorize');var isTokenExchange=$(ctx).attr('data-row-is-token-exchange');if(!url.hasOwnProperty(dialog)){throw'Invalid dialog type';}
var integrationId=$(ctx).attr('data-row-id');if(!integrationId){throw'Unable to find integration ID';}
var ajaxUrl=url[dialog].replace(':id',integrationId).replace(':isReauthorize',isReauthorize);try{var integrationName=$(ctx).attr('data-row-name')||$(ctx).parents('tr').find('.col-name').html().trim();if(integrationName.indexOf('<span')>-1){integrationName=integrationName.substring(0,integrationName.indexOf('<span'));}}catch(e){throw'Unable to find integration name';}
var okButton={permissions:{text:(isReauthorize=='1')?$.mage.__('Reauthorize'):$.mage.__('Allow'),'class':'action-primary',attr:{'data-row-id':integrationId,'data-row-name':integrationName,'data-row-dialog':(isTokenExchange=='1')?'tokensExchange':'tokens','data-row-is-reauthorize':isReauthorize,'data-row-is-token-exchange':isTokenExchange},click:function(){var ctx=this.modal.find('button.action-primary').clone(true);this.closeModal();this.modal.remove();window.integration.popup.show(ctx);}},tokens:{text:$.mage.__('Done'),'class':'action-primary',click:function(){window.location.href=url.grid;}}};_showPopup(dialog,integrationName,okButton[dialog],ajaxUrl);}}};};return $.mage.integration;});