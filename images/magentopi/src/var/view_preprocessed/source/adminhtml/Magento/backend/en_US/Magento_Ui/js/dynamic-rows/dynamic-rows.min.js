define(['ko','mageUtils','underscore','uiLayout','uiCollection','uiRegistry','mage/translate'],function(ko,utils,_,layout,uiCollection,registry,$t){'use strict';return uiCollection.extend({defaults:{defaultRecord:false,columnsHeader:true,columnsHeaderAfterRender:false,columnsHeaderClasses:'',labels:[],recordTemplate:'record',collapsibleHeader:false,additionalClasses:{},visible:true,disabled:false,fit:false,addButton:true,addButtonLabel:$t('Add'),recordData:[],maxPosition:0,deleteProperty:'delete',identificationProperty:'record_id',deleteValue:true,showSpinner:true,isDifferedFromDefault:false,fallbackResetTpl:'ui/form/element/helper/fallback-reset-link',dndConfig:{name:'${ $.name }_dnd',component:'Magento_Ui/js/dynamic-rows/dnd',template:'ui/dynamic-rows/cells/dnd',recordsProvider:'${ $.name }',enabled:true},templates:{record:{parent:'${ $.$data.collection.name }',name:'${ $.$data.index }',dataScope:'${ $.$data.collection.index }.${ $.name }',nodeTemplate:'${ $.parent }.${ $.$data.collection.recordTemplate }'}},links:{recordData:'${ $.provider }:${ $.dataScope }.${ $.index }'},listens:{visible:'setVisible',disabled:'setDisabled',childTemplate:'initHeader',recordTemplate:'onUpdateRecordTemplate',recordData:'setDifferedFromDefault parsePagesData',currentPage:'changePage',elems:'checkSpinner'},modules:{dnd:'${ $.dndConfig.name }'},pages:1,pageSize:20,relatedData:[],currentPage:1,startIndex:0},initialize:function(){this._super().initChildren().initDnd().setColumnsHeaderListener().initDefaultRecord().checkSpinner();return this;},initObservable:function(){this._super().track('childTemplate').observe(['pages','currentPage','recordData','columnsHeader','visible','disabled','labels','showSpinner','isDifferedFromDefault']);return this;},initDnd:function(){if(this.dndConfig.enabled){layout([this.dndConfig]);}
return this;},setColumnsHeaderListener:function(){if(this.columnsHeaderAfterRender){this.on('recordData',this.renderColumnsHeader.bind(this));}
return this;},renderColumnsHeader:function(){this.recordData().length?this.columnsHeader(true):this.columnsHeader(false);},initDefaultRecord:function(){if(this.defaultRecord&&!this.recordData().length){this.addChild();}
return this;},createHeaderTemplate:function(prop){var visible=prop.visible!==false,disabled=_.isUndefined(prop.disabled)?this.disabled():prop.disabled;return{visible:ko.observable(visible),disabled:ko.observable(disabled)};},initHeader:function(){var data;if(!this.labels().length){_.each(this.childTemplate.children,function(cell){data=this.createHeaderTemplate(cell.config);cell.config.labelVisible=false;_.extend(data,{label:cell.config.label,name:cell.name,columnsHeaderClasses:cell.config.columnsHeaderClasses});this.labels.push(data);},this);}},setMaxPosition:function(position,elem){if(position){this.checkMaxPosition(position);this.sort(position,elem);}else{this.maxPosition+=1;}},sort:function(position,elem){var that=this,sorted,updatedCollection;if(this.elems().filter(function(el){return el.position;}).length!==this.getChildItems().length){return false;}
if(!elem.containers.length){registry.get(elem.name,function(){that.sort(position,elem);});return false;}
sorted=this.elems().sort(function(propOne,propTwo){return~~propOne.position-~~propTwo.position;});updatedCollection=this.updatePosition(sorted,position,elem.name);this.elems(updatedCollection);},checkSpinner:function(elems){this.showSpinner(!(!this.recordData().length||elems&&elems.length===this.getChildItems().length));},parsePagesData:function(data){var pages;this.relatedData=this.deleteProperty?_.filter(data,function(elem){return elem[this.deleteProperty]!==this.deleteValue;},this):data;pages=Math.ceil(this.relatedData.length / this.pageSize)||1;this.pages(pages);},getChildItems:function(){this.startIndex=(~~this.currentPage()-1)*this.pageSize;return this.relatedData.slice(this.startIndex,this.startIndex+this.pageSize);},getColumnsCount:function(){return this.labels().length+(this.dndConfig.enabled?1:0);},processingAddChild:function(ctx,index,prop){if(this.relatedData.length&&this.relatedData.length%this.pageSize===0){this.clear();this.pages(this.pages()+1);this.currentPage(this.pages());}else if(~~this.currentPage()!==this.pages()){this.currentPage(this.pages());}
this.addChild(ctx,index,prop);},processingDeleteRecord:function(index,recordId){this.deleteRecord(index,recordId);if(this.getChildItems().length<=0&&this.pages()!==1){this.pages(this.pages()-1);this.currentPage(this.pages());}},changePage:function(page){if(page===1&&!this.recordData().length){return false;}
if(~~page>this.pages()){this.currentPage(this.pages());return false;}else if(~~page<1){this.currentPage(1);return false;}
this.clear();this.initChildren();},isFirst:function(){return this.currentPage()===1;},isLast:function(){return this.currentPage()===this.pages();},nextPage:function(){this.currentPage(this.currentPage()+1);},previousPage:function(){this.currentPage(this.currentPage()-1);},updatePosition:function(collection,position,elemName){var curPos,parsePosition=~~position,result=_.filter(collection,function(record){return~~record.position===parsePosition;});if(result[1]){curPos=parsePosition+1;result[0].name===elemName?result[1].position=curPos:result[0].position=curPos;this.updatePosition(collection,curPos);}
return collection;},checkMaxPosition:function(position){var max=0,pos;this.elems.each(function(record){pos=~~record.position;pos>max?max=pos:false;});max<position?max=position:false;this.maxPosition=max;},removeMaxPosition:function(){this.maxPosition=0;this.elems.each(function(record){this.maxPosition<record.position?this.maxPosition=~~record.position:false;},this);},onUpdateRecordTemplate:function(recordName){if(recordName){this.recordTemplate=recordName;this.reload();}},deleteRecord:function(index,recordId){var recordInstance,lastRecord,recordsData,childs;if(this.deleteProperty){recordInstance=_.find(this.elems(),function(elem){return elem.index===index;});recordInstance.destroy();this.elems([]);this._updateCollection();this.removeMaxPosition();this.recordData()[recordInstance.index][this.deleteProperty]=this.deleteValue;this.recordData.valueHasMutated();childs=this.getChildItems();if(childs.length>this.elems().length){this.addChild(false,childs[childs.length-1][this.identificationProperty],false);}}else{this.update=true;if(~~this.currentPage()===this.pages()){lastRecord=_.findWhere(this.elems(),{index:this.startIndex+this.getChildItems().length-1})||_.findWhere(this.elems(),{index:(this.startIndex+this.getChildItems().length-1).toString()});lastRecord.destroy();}
this.removeMaxPosition();recordsData=this._getDataByProp(recordId);this._updateData(recordsData);this.update=false;}
if(this.pages()<~~this.currentPage()){this.currentPage(this.pages());}
this._sort();},_getDataByProp:function(id,prop){prop=prop||this.identificationProperty;return _.reject(this.getChildItems(),function(recordData){return~~recordData[prop]===~~id;},this);},_sort:function(){this.elems(this.elems().sort(function(propOne,propTwo){return~~propOne.position-~~propTwo.position;}));},_updateData:function(data){var elems=_.clone(this.elems()),path,dataArr;dataArr=this.recordData.splice(this.startIndex,this.recordData().length-this.startIndex);dataArr.splice(0,this.pageSize);elems=_.sortBy(this.elems(),function(elem){return~~elem.index;});data.concat(dataArr).forEach(function(rec,idx){if(elems[idx]){elems[idx].recordId=rec[this.identificationProperty];}
if(!rec.position){rec.position=this.maxPosition;this.setMaxPosition();}
path=this.dataScope+'.'+this.index+'.'+(this.startIndex+idx);this.source.set(path,rec);},this);this.elems(elems);},reload:function(){this.clear();this.initChildren(false,true);},clear:function(){this.destroyChildren();return this;},reset:function(){var elems=this.elems();_.each(elems,function(elem){if(_.isFunction(elem.reset)){elem.reset();}});},setClasses:function(data){var additional;if(_.isString(data.additionalClasses)){additional=data.additionalClasses.split(' ');data.additionalClasses={};additional.forEach(function(name){data.additionalClasses[name]=true;});}
if(!data.additionalClasses){data.additionalClasses={};}
_.extend(data.additionalClasses,{'_fit':data.fit,'_required':data.required,'_error':data.error,'_empty':!this.elems().length,'_no-header':this.columnsHeaderAfterRender||this.collapsibleHeader});return data.additionalClasses;},initChildren:function(){this.showSpinner(true);this.getChildItems().forEach(function(data,index){this.addChild(data,this.startIndex+index);},this);return this;},setVisible:function(state){this.elems.each(function(record){record.setVisible(state);},this);},setDisabled:function(state){this.elems.each(function(record){record.setDisabled(state);},this);},setVisibilityColumn:function(index,state){this.elems.each(function(record){record.setVisibilityColumn(index,state);},this);},setDisabledColumn:function(index,state){this.elems.each(function(record){record.setDisabledColumn(index,state);},this);},addChild:function(data,index,prop){var template=this.templates.record,child;index=index||_.isNumber(index)?index:this.recordData().length;prop=prop||_.isNumber(prop)?prop:index;_.extend(this.templates.record,{recordId:prop});child=utils.template(template,{collection:this,index:index});layout([child]);return this;},restoreToDefault:function(){this.recordData(utils.copy(this.default));this.reload();},setDifferedFromDefault:function(){var recordData=utils.copy(this.recordData());Array.isArray(recordData)&&recordData.forEach(function(item){delete item['record_id'];});this.isDifferedFromDefault(!_.isEqual(recordData,this.default));}});});