define(["jquery",'Magento_Ui/js/modal/alert','Magento_Ui/js/modal/confirm',"jquery/editableMultiselect/js/jquery.editable","jquery/editableMultiselect/js/jquery.multiselect"],function($,alert,confirm){EditableMultiselect=function(settings){this.settings=settings||{};this.addButtonCaption=this.settings.add_button_caption||'Add new value';this.newUrl=this.settings.new_url;this.saveUrl=this.settings.save_url;this.deleteUrl=this.settings.delete_url;this.deleteConfirmMessage=this.settings.delete_confirm_message;this.targetSelectId=this.settings.target_select_id;this.submitData=this.settings.submit_data||{};this.entityIdName=this.settings.entity_id_name||'entity_id';this.entityValueName=this.settings.entity_value_name||'entity_value';this.isEntityEditable=this.settings.is_entity_editable||false;EditableMultiselect.prototype.init=function(){var self=this;var mselectOptions={addText:this.addButtonCaption,mselectInputSubmitCallback:function(value,options){self.createEntity(value,options);}};if(!this.isEntityEditable){mselectOptions.layout='<section class="block %mselectListClass%">'+'<div class="block-content"><div class="%mselectItemsWrapperClass%">'+'%items%'+'</div></div>'+'<div class="%mselectInputContainerClass%">'+'<input type="text" class="%mselectInputClass%" title="%inputTitle%"/>'+'<span class="%mselectButtonCancelClass%" title="%cancelText%"></span>'+'<span class="%mselectButtonSaveClass%" title="Add"></span>'+'</div>'+'</section>';}
$('#'+this.targetSelectId).multiselect(mselectOptions);if(this.isEntityEditable){this.makeMultiselectEditable();var mselectList=$('#'+this.targetSelectId).next();this.attachEventsToControls(mselectList);}};EditableMultiselect.prototype.attachEventsToControls=function(mselectList)
{mselectList.on("click.mselect-delete",'.mselect-delete',{container:this},function(event){event.data.container.deleteEntity({delete_button:this});});mselectList.on('click.mselect-checked','.mselect-list-item input',{container:this},function(event){var el=$(this),checkedClassName='mselect-checked';el[el.is(':checked')?'addClass':'removeClass'](checkedClassName);event.data.container.makeMultiselectEditable();});mselectList.on('click.mselect-edit','.mselect-edit',{container:this},function(event){event.data.container.makeMultiselectEditable();$(this).parent().find('label span').trigger("dblclick");});};EditableMultiselect.prototype.makeMultiselectEditable=function(){var entityIdName=this.entityIdName,entityValueName=this.entityValueName,selectList=$('#'+this.targetSelectId).next();selectList.find('.mselect-list-item:not(.mselect-list-item-not-editable) label span').editable(this.saveUrl,{type:'text',submit:'<button class="mselect-save" title="Save" type="submit" />',cancel:'<span class="mselect-cancel" title="Cancel"></span>',event:'dblclick',placeholder:'',isChecked:function(settings){var that=$(this);if(!that.closest('.mselect-list-item').hasClass('mselect-disabled')){var checked=that.parent().find('[type=checkbox]').prop('disabled');that.parent().find('[type=checkbox]').prop({disabled:!checked});}},data:function(value,settings){settings.isChecked.apply(this,[settings]);if(typeof value==='string'){var retval=value.unescapeHTML();return(retval);}
return value;},submitdata:this.submitData,onblur:'cancel',name:entityValueName,ajaxoptions:{dataType:'json'},onsubmit:function(settings,original){var select=$(original).closest('.mselect-list').prev(),current=$(original).closest('.mselect-list-item').index(),entityId=select.find('option').eq(current).val();var entityInfo={};entityInfo[entityIdName]=entityId;settings.submitdata=$.extend(settings.submitdata||{},entityInfo);},callback:function(result,settings){settings.isChecked.apply(this,[settings]);var select=$(this).closest('.mselect-list').prev(),current=$(this).closest('.mselect-list-item').index();if(result.success){if(typeof result[entityValueName]==='string'){select.find('option').eq(current).val(result[entityIdName]).text(result[entityValueName]);$(this).html(result[entityValueName].escapeHTML());}}else{alert({content:result.error_message});}}});};EditableMultiselect.prototype.createEntity=function(value,options){if(!value){return;}
var select=$('#'+this.targetSelectId),entityIdName=this.entityIdName,entityValueName=this.entityValueName,entityInfo={};entityInfo[entityIdName]=null;entityInfo[entityValueName]=value;var postData=$.extend(entityInfo,this.submitData);var ajaxOptions={type:'POST',data:postData,dataType:'json',url:this.newUrl,success:function(result,status){if(result.success){var resultEntityValueName="";if(typeof result[entityValueName]==='string'){resultEntityValueName=result[entityValueName].escapeHTML();}else{resultEntityValueName=result[entityValueName];}
select.append('<option value="'+result[entityIdName]+'" selected="selected">'+
resultEntityValueName+'</option>');var mselectItemHtml=$(options.item.replace(/%value%|%label%/gi,resultEntityValueName).replace(/%mselectDisabledClass%|%iseditable%|%isremovable%/gi,'').replace(/%mselectListItemClass%/gi,options.mselectListItemClass)).find('[type=checkbox]').attr('checked',true).addClass(options.mselectCheckedClass).end(),sectionBlock=select.nextAll('section.block:first'),itemsWrapper=sectionBlock.find('.'+options.mselectItemsWrapperClass+'');if(itemsWrapper.children('.'+options.mselectListItemClass+'').length){itemsWrapper.children('.'+options.mselectListItemClass+':last').after(mselectItemHtml);}else{itemsWrapper.prepend(mselectItemHtml);}
var inputSelector='.'+options.mselectInputContainerClass+' [type=text].'+
options.mselectInputClass+'';sectionBlock.find(inputSelector).trigger('blur');}else{alert({content:result.error_message});}}};$.ajax(ajaxOptions);};EditableMultiselect.prototype.deleteEntity=function(options){var self=this;if(options.delete_button){confirm({content:this.deleteConfirmMessage,actions:{confirm:function(){var deleteButton=$(options.delete_button),index=deleteButton.parent().index(),select=deleteButton.closest('.mselect-list').prev(),entityId=select.find('option').eq(index).val(),entityInfo={};entityInfo[self.entityIdName]=entityId;var postData=$.extend(entityInfo,self.submitData);var ajaxOptions={type:'POST',data:postData,dataType:'json',url:self.deleteUrl,success:function(result,status){if(result.success){deleteButton.parent().remove();select.find('option').eq(index).remove();}else{alert({content:result.error_message});}}};$.ajax(ajaxOptions);}}});}};};});