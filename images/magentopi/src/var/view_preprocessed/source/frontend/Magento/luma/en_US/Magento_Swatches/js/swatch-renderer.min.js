define(['jquery','underscore','jquery/ui','jquery/jquery.parsequery'],function($,_){'use strict';$.widget('mage.SwatchRendererTooltip',{options:{delay:200,tooltipClass:'swatch-option-tooltip'},_init:function(){var $widget=this,$this=this.element,$element=$('.'+$widget.options.tooltipClass),timer,type=parseInt($this.attr('option-type'),10),label=$this.attr('option-label'),thumb=$this.attr('option-tooltip-thumb'),value=$this.attr('option-tooltip-value'),$image,$title,$corner;if(!$element.size()){$element=$('<div class="'+
$widget.options.tooltipClass+'"><div class="image"></div><div class="title"></div><div class="corner"></div></div>');$('body').append($element);}
$image=$element.find('.image');$title=$element.find('.title');$corner=$element.find('.corner');$this.hover(function(){if(!$this.hasClass('disabled')){timer=setTimeout(function(){var leftOpt=null,leftCorner=0,left,$window;if(type===2){$image.css({'background':'url("'+thumb+'") no-repeat center','background-size':'initial'});$image.show();}else if(type===1){$image.css({background:value});$image.show();}else if(type===0||type===3){$image.hide();}
$title.text(label);leftOpt=$this.offset().left;left=leftOpt+$this.width()/ 2-$element.width()/ 2;$window=$(window);if(left<0){left=5;}else if(left+$element.width()>$window.width()){left=$window.width()-$element.width()-5;}
leftCorner=0;if($element.width()<$this.width()){leftCorner=$element.width()/ 2-3;}else{leftCorner=(leftOpt>left?leftOpt-left:left-leftOpt)+$this.width()/ 2-6;}
$corner.css({left:leftCorner});$element.css({left:left,top:$this.offset().top-$element.height()-$corner.height()-18}).show();},$widget.options.delay);}},function(){$element.hide();clearTimeout(timer);});$(document).on('tap',function(){$element.hide();clearTimeout(timer);});$this.on('tap',function(event){event.stopPropagation();});}});$.widget('mage.SwatchRenderer',{options:{classes:{attributeClass:'swatch-attribute',attributeLabelClass:'swatch-attribute-label',attributeSelectedOptionLabelClass:'swatch-attribute-selected-option',attributeOptionsWrapper:'swatch-attribute-options',attributeInput:'swatch-input',optionClass:'swatch-option',selectClass:'swatch-select',moreButton:'swatch-more',loader:'swatch-option-loading'},jsonConfig:{},jsonSwatchConfig:{},selectorProduct:'.product-info-main',selectorProductPrice:'[data-role=priceBox]',mediaGallerySelector:'[data-gallery-role=gallery-placeholder]',numberToShow:false,onlySwatches:false,enableControlLabel:true,moreButtonText:'More',mediaCallback:'',mediaCache:{},mediaGalleryInitial:[{}],onlyMainImg:false,slyOldPriceSelector:'.sly-old-price'},getProduct:function(){return this._CalcProducts().shift();},_init:function(){if(this.options.jsonConfig!==''&&this.options.jsonSwatchConfig!==''){this._sortAttributes();this._RenderControls();}else{console.log('SwatchRenderer: No input data received');}},_sortAttributes:function(){this.options.jsonConfig.attributes=_.sortBy(this.options.jsonConfig.attributes,function(attribute){return attribute.position;});},_create:function(){var options=this.options,gallery=$('[data-gallery-role=gallery-placeholder]','.column.main'),isProductViewExist=$('body.catalog-product-view').size()>0,$main=isProductViewExist?this.element.parents('.column.main'):this.element.parents('.product-item-info');if(isProductViewExist){gallery.on('gallery:loaded',function(){var galleryObject=gallery.data('gallery');options.mediaGalleryInitial=galleryObject.returnCurrentImages();});}else{options.mediaGalleryInitial=[{'img':$main.find('.product-image-photo').attr('src')}];}
this.productForm=this.element.parents(this.options.selectorProduct).find('form:first');},_RenderControls:function(){var $widget=this,container=this.element,classes=this.options.classes,chooseText=this.options.jsonConfig.chooseText;$widget.optionsMap={};$.each(this.options.jsonConfig.attributes,function(){var item=this,options=$widget._RenderSwatchOptions(item),select=$widget._RenderSwatchSelect(item,chooseText),input=$widget._RenderFormInput(item),label='';if($widget.options.onlySwatches&&!$widget.options.jsonSwatchConfig.hasOwnProperty(item.id)){return;}
if($widget.options.enableControlLabel){label+='<span class="'+classes.attributeLabelClass+'">'+item.label+'</span>'+'<span class="'+classes.attributeSelectedOptionLabelClass+'"></span>';}
if($widget.productForm){$widget.productForm.append(input);input='';}
container.append('<div class="'+classes.attributeClass+' '+item.code+'" attribute-code="'+item.code+'" attribute-id="'+item.id+'">'+
label+'<div class="'+classes.attributeOptionsWrapper+' clearfix">'+
options+select+'</div>'+input+'</div>');$widget.optionsMap[item.id]={};$.each(item.options,function(){if(this.products.length>0){$widget.optionsMap[item.id][this.id]={price:parseInt($widget.options.jsonConfig.optionPrices[this.products[0]].finalPrice.amount,10),products:this.products};}});});container.find('[option-type="1"], [option-type="2"], [option-type="0"], [option-type="3"]').SwatchRendererTooltip();$('.'+classes.moreButton).nextAll().hide();$widget._EventListener();$widget._Rewind(container);$widget._EmulateSelected($.parseQuery());$widget._EmulateSelected($widget._getSelectedAttributes());},_RenderSwatchOptions:function(config){var optionConfig=this.options.jsonSwatchConfig[config.id],optionClass=this.options.classes.optionClass,moreLimit=parseInt(this.options.numberToShow,10),moreClass=this.options.classes.moreButton,moreText=this.options.moreButtonText,countAttributes=0,html='';if(!this.options.jsonSwatchConfig.hasOwnProperty(config.id)){return'';}
$.each(config.options,function(){var id,type,value,thumb,label,attr;if(!optionConfig.hasOwnProperty(this.id)){return'';}
if(moreLimit===countAttributes++){html+='<a href="#" class="'+moreClass+'">'+moreText+'</a>';}
id=this.id;type=parseInt(optionConfig[id].type,10);value=optionConfig[id].hasOwnProperty('value')?optionConfig[id].value:'';thumb=optionConfig[id].hasOwnProperty('thumb')?optionConfig[id].thumb:'';label=this.label?this.label:'';attr=' option-type="'+type+'"'+' option-id="'+id+'"'+' option-label="'+label+'"'+' option-tooltip-thumb="'+thumb+'"'+' option-tooltip-value="'+value+'"';if(!this.hasOwnProperty('products')||this.products.length<=0){attr+=' option-empty="true"';}
if(type===0){html+='<div class="'+optionClass+' text" '+attr+'>'+(value?value:label)+'</div>';}else if(type===1){html+='<div class="'+optionClass+' color" '+attr+'" style="background: '+value+' no-repeat center; background-size: initial;">'+''+'</div>';}else if(type===2){html+='<div class="'+optionClass+' image" '+attr+'" style="background: url('+value+') no-repeat center; background-size: initial;">'+''+'</div>';}else if(type===3){html+='<div class="'+optionClass+'" '+attr+'></div>';}else{html+='<div class="'+optionClass+'" '+attr+'>'+label+'</div>';}});return html;},_RenderSwatchSelect:function(config,chooseText){var html;if(this.options.jsonSwatchConfig.hasOwnProperty(config.id)){return'';}
html='<select class="'+this.options.classes.selectClass+' '+config.code+'">'+'<option value="0" option-id="0">'+chooseText+'</option>';$.each(config.options,function(){var label=this.label,attr=' value="'+this.id+'" option-id="'+this.id+'"';if(!this.hasOwnProperty('products')||this.products.length<=0){attr+=' option-empty="true"';}
html+='<option '+attr+'>'+label+'</option>';});html+='</select>';return html;},_RenderFormInput:function(config){return'<input class="'+this.options.classes.attributeInput+' super-attribute-select" '+'name="super_attribute['+config.id+']" '+'type="text" '+'value="" '+'data-selector="super_attribute['+config.id+']" '+'data-validate="{required:true}" '+'aria-required="true" '+'aria-invalid="true" '+'style="visibility: hidden; position:absolute; left:-1000px">';},_EventListener:function(){var $widget=this;$widget.element.on('click','.'+this.options.classes.optionClass,function(){return $widget._OnClick($(this),$widget);});$widget.element.on('change','.'+this.options.classes.selectClass,function(){return $widget._OnChange($(this),$widget);});$widget.element.on('click','.'+this.options.classes.moreButton,function(e){e.preventDefault();return $widget._OnMoreClick($(this));});},_OnClick:function($this,$widget){var $parent=$this.parents('.'+$widget.options.classes.attributeClass),$label=$parent.find('.'+$widget.options.classes.attributeSelectedOptionLabelClass),attributeId=$parent.attr('attribute-id'),$input=$widget.productForm.find('.'+$widget.options.classes.attributeInput+'[name="super_attribute['+attributeId+']"]');if($this.hasClass('disabled')){return;}
if($this.hasClass('selected')){$parent.removeAttr('option-selected').find('.selected').removeClass('selected');$input.val('');$label.text('');}else{$parent.attr('option-selected',$this.attr('option-id')).find('.selected').removeClass('selected');$label.text($this.attr('option-label'));$input.val($this.attr('option-id'));$this.addClass('selected');}
$widget._Rebuild();if($widget.element.parents($widget.options.selectorProduct).find(this.options.selectorProductPrice).is(':data(mage-priceBox)')){$widget._UpdatePrice();}
$widget._LoadProductMedia();$input.trigger('change');},_OnChange:function($this,$widget){var $parent=$this.parents('.'+$widget.options.classes.attributeClass),attributeId=$parent.attr('attribute-id'),$input=$widget.productForm.find('.'+$widget.options.classes.attributeInput+'[name="super_attribute['+attributeId+']"]');if($this.val()>0){$parent.attr('option-selected',$this.val());$input.val($this.val());}else{$parent.removeAttr('option-selected');$input.val('');}
$widget._Rebuild();$widget._UpdatePrice();$widget._LoadProductMedia();$input.trigger('change');},_OnMoreClick:function($this){$this.nextAll().show();$this.blur().remove();},_Rewind:function(controls){controls.find('div[option-id], option[option-id]').removeClass('disabled').removeAttr('disabled');controls.find('div[option-empty], option[option-empty]').attr('disabled',true).addClass('disabled');},_Rebuild:function(){var $widget=this,controls=$widget.element.find('.'+$widget.options.classes.attributeClass+'[attribute-id]'),selected=controls.filter('[option-selected]');$widget._Rewind(controls);if(selected.size()<=0){return;}
controls.each(function(){var $this=$(this),id=$this.attr('attribute-id'),products=$widget._CalcProducts(id);if(selected.size()===1&&selected.first().attr('attribute-id')===id){return;}
$this.find('[option-id]').each(function(){var $element=$(this),option=$element.attr('option-id');if(!$widget.optionsMap.hasOwnProperty(id)||!$widget.optionsMap[id].hasOwnProperty(option)||$element.hasClass('selected')||$element.is(':selected')){return;}
if(_.intersection(products,$widget.optionsMap[id][option].products).length<=0){$element.attr('disabled',true).addClass('disabled');}});});},_CalcProducts:function($skipAttributeId){var $widget=this,products=[];$widget.element.find('.'+$widget.options.classes.attributeClass+'[option-selected]').each(function(){var id=$(this).attr('attribute-id'),option=$(this).attr('option-selected');if($skipAttributeId!==undefined&&$skipAttributeId===id){return;}
if(!$widget.optionsMap.hasOwnProperty(id)||!$widget.optionsMap[id].hasOwnProperty(option)){return;}
if(products.length===0){products=$widget.optionsMap[id][option].products;}else{products=_.intersection(products,$widget.optionsMap[id][option].products);}});return products;},_UpdatePrice:function(){var $widget=this,$product=$widget.element.parents($widget.options.selectorProduct),$productPrice=$product.find(this.options.selectorProductPrice),options=_.object(_.keys($widget.optionsMap),{}),result;$widget.element.find('.'+$widget.options.classes.attributeClass+'[option-selected]').each(function(){var attributeId=$(this).attr('attribute-id');options[attributeId]=$(this).attr('option-selected');});result=$widget.options.jsonConfig.optionPrices[_.findKey($widget.options.jsonConfig.index,options)];$productPrice.trigger('updatePrice',{'prices':$widget._getPrices(result,$productPrice.priceBox('option').prices)});if(result.oldPrice.amount!==result.finalPrice.amount){$(this.options.slyOldPriceSelector).show();}else{$(this.options.slyOldPriceSelector).hide();}},_getPrices:function(newPrices,displayPrices){var $widget=this;if(_.isEmpty(newPrices)){newPrices=$widget.options.jsonConfig.prices;}
_.each(displayPrices,function(price,code){if(newPrices[code]){displayPrices[code].amount=newPrices[code].amount-displayPrices[code].amount;}});return displayPrices;},_LoadProductMedia:function(){var $widget=this,$this=$widget.element,attributes={},productId=0,mediaCallData,mediaCacheKey,mediaSuccessCallback=function(data){if(!(mediaCacheKey in $widget.options.mediaCache)){$widget.options.mediaCache[mediaCacheKey]=data;}
$widget._ProductMediaCallback($this,data);$widget._DisableProductMediaLoader($this);};if(!$widget.options.mediaCallback){return;}
$this.find('[option-selected]').each(function(){var $selected=$(this);attributes[$selected.attr('attribute-code')]=$selected.attr('option-selected');});if($('body.catalog-product-view').size()>0){productId=document.getElementsByName('product')[0].value;}else{productId=$this.parents('.product.details.product-item-details').find('.price-box.price-final_price').attr('data-product-id');}
mediaCallData={'product_id':productId,'attributes':attributes,'additional':$.parseQuery()};mediaCacheKey=JSON.stringify(mediaCallData);if(mediaCacheKey in $widget.options.mediaCache){mediaSuccessCallback($widget.options.mediaCache[mediaCacheKey]);}else{mediaCallData.isAjax=true;$widget._XhrKiller();$widget._EnableProductMediaLoader($this);$widget.xhr=$.post($widget.options.mediaCallback,mediaCallData,mediaSuccessCallback,'json').done(function(){$widget._XhrKiller();});}},_EnableProductMediaLoader:function($this){var $widget=this;if($('body.catalog-product-view').size()>0){$this.parents('.column.main').find('.photo.image').addClass($widget.options.classes.loader);}else{$this.parents('.product-item-info').find('.product-image-photo').addClass($widget.options.classes.loader);}},_DisableProductMediaLoader:function($this){var $widget=this;if($('body.catalog-product-view').size()>0){$this.parents('.column.main').find('.photo.image').removeClass($widget.options.classes.loader);}else{$this.parents('.product-item-info').find('.product-image-photo').removeClass($widget.options.classes.loader);}},_ProductMediaCallback:function($this,response){var isProductViewExist=$('body.catalog-product-view').size()>0,$main=isProductViewExist?$this.parents('.column.main'):$this.parents('.product-item-info'),$widget=this,images=[],support=function(e){return e.hasOwnProperty('large')&&e.hasOwnProperty('medium')&&e.hasOwnProperty('small');};if(_.size($widget)<1||!support(response)){this.updateBaseImage(this.options.mediaGalleryInitial,$main,isProductViewExist);return;}
images.push({full:response.large,img:response.medium,thumb:response.small,isMain:true});if(response.hasOwnProperty('gallery')){$.each(response.gallery,function(){if(!support(this)||response.large===this.large){return;}
images.push({full:this.large,img:this.medium,thumb:this.small});});}
this.updateBaseImage(images,$main,isProductViewExist);},_setImageType:function(images){var initial=this.options.mediaGalleryInitial[0].img;if(images[0].img===initial){images=$.extend(true,[],this.options.mediaGalleryInitial);}else{images.map(function(img){img.type='image';});}
return images;},updateBaseImage:function(images,context,isProductViewExist){var justAnImage=images[0],updateImg,imagesToUpdate,gallery=context.find(this.options.mediaGallerySelector).data('gallery'),item;if(isProductViewExist){imagesToUpdate=images.length?this._setImageType($.extend(true,[],images)):[];if(this.options.onlyMainImg){updateImg=imagesToUpdate.filter(function(img){return img.isMain;});item=updateImg.length?updateImg[0]:imagesToUpdate[0];gallery.updateDataByIndex(0,item);gallery.seek(1);}else{gallery.updateData(imagesToUpdate);$(this.options.mediaGallerySelector).AddFotoramaVideoEvents();}}else if(justAnImage&&justAnImage.img){context.find('.product-image-photo').attr('src',justAnImage.img);}},_XhrKiller:function(){var $widget=this;if($widget.xhr!==undefined&&$widget.xhr!==null){$widget.xhr.abort();$widget.xhr=null;}},_EmulateSelected:function(selectedAttributes){$.each(selectedAttributes,$.proxy(function(attributeCode,optionId){this.element.find('.'+this.options.classes.attributeClass+'[attribute-code="'+attributeCode+'"] [option-id="'+optionId+'"]').trigger('click');},this));},_getSelectedAttributes:function(){var hashIndex=window.location.href.indexOf('#'),selectedAttributes={},params;if(hashIndex!==-1){params=$.parseQuery(window.location.href.substr(hashIndex+1));selectedAttributes=_.invert(_.mapObject(_.invert(params),function(attributeId){var attribute=this.options.jsonConfig.attributes[attributeId];return attribute?attribute.code:attributeId;}.bind(this)));}
return selectedAttributes;}});return $.mage.SwatchRenderer;});